# SLO Templates by Tier and Service Type
# Version: 1.0.0
# Format: Sloth (https://sloth.dev)

templates:
  # HTTP API SERVICE TEMPLATES
  http-api:
    tier-1:
      availability:
        target: 99.9  # 43m downtime/month
        sli_query: |
          sum(rate(http_requests_total{service="{{service}}",code!~"5.."}[{{window}}]))
          /
          sum(rate(http_requests_total{service="{{service}}"}[{{window}}]))
        error_budget_burn:
          fast: 2h    # Page if burning 1% error budget in 2h
          slow: 24h   # Warn if burning 5% error budget in 24h

      latency_p99:
        target: 99.0  # 99% of requests under threshold
        threshold_ms: 500
        sli_query: |
          histogram_quantile(0.99,
            sum(rate(http_request_duration_seconds_bucket{service="{{service}}"}[{{window}}])) by (le)
          ) < 0.5

      latency_p95:
        target: 99.5  # 99.5% of requests under threshold
        threshold_ms: 200
        sli_query: |
          histogram_quantile(0.95,
            sum(rate(http_request_duration_seconds_bucket{service="{{service}}"}[{{window}}])) by (le)
          ) < 0.2

      error_rate:
        target: 99.9  # < 0.1% errors
        sli_query: |
          sum(rate(http_requests_total{service="{{service}}",code!~"5.."}[{{window}}]))
          /
          sum(rate(http_requests_total{service="{{service}}"}[{{window}}]))

    tier-2:
      availability:
        target: 99.5  # 3.6h downtime/month
        sli_query: |
          sum(rate(http_requests_total{service="{{service}}",code!~"5.."}[{{window}}]))
          /
          sum(rate(http_requests_total{service="{{service}}"}[{{window}}]))
        error_budget_burn:
          fast: 2h
          slow: 24h

      latency_p99:
        target: 99.0
        threshold_ms: 1000
        sli_query: |
          histogram_quantile(0.99,
            sum(rate(http_request_duration_seconds_bucket{service="{{service}}"}[{{window}}])) by (le)
          ) < 1.0

      latency_p95:
        target: 99.5
        threshold_ms: 500
        sli_query: |
          histogram_quantile(0.95,
            sum(rate(http_request_duration_seconds_bucket{service="{{service}}"}[{{window}}])) by (le)
          ) < 0.5

      error_rate:
        target: 99.0  # < 1% errors
        sli_query: |
          sum(rate(http_requests_total{service="{{service}}",code!~"5.."}[{{window}}]))
          /
          sum(rate(http_requests_total{service="{{service}}"}[{{window}}]))

    tier-3:
      availability:
        target: 99.0  # 7.2h downtime/month
        sli_query: |
          sum(rate(http_requests_total{service="{{service}}",code!~"5.."}[{{window}}]))
          /
          sum(rate(http_requests_total{service="{{service}}"}[{{window}}]))
        error_budget_burn:
          fast: 6h
          slow: 72h

      latency_p95:
        target: 95.0
        threshold_ms: 2000
        sli_query: |
          histogram_quantile(0.95,
            sum(rate(http_request_duration_seconds_bucket{service="{{service}}"}[{{window}}])) by (le)
          ) < 2.0

      error_rate:
        target: 95.0  # < 5% errors
        sli_query: |
          sum(rate(http_requests_total{service="{{service}}",code!~"5.."}[{{window}}]))
          /
          sum(rate(http_requests_total{service="{{service}}"}[{{window}}]))

  # BATCH JOB TEMPLATES
  batch-job:
    tier-1:
      success_rate:
        target: 99.9  # 99.9% of jobs succeed
        sli_query: |
          sum(rate(batch_job_completed{service="{{service}}",status="success"}[{{window}}]))
          /
          sum(rate(batch_job_completed{service="{{service}}"}[{{window}}]))
        error_budget_burn:
          fast: 2h
          slow: 24h

      duration_p95:
        target: 95.0  # 95% complete within expected time
        threshold_minutes: 30  # Adjust based on job
        sli_query: |
          histogram_quantile(0.95,
            sum(rate(batch_job_duration_seconds_bucket{service="{{service}}"}[{{window}}])) by (le)
          ) < (30 * 60)  # 30 minutes

    tier-2:
      success_rate:
        target: 99.5
        sli_query: |
          sum(rate(batch_job_completed{service="{{service}}",status="success"}[{{window}}]))
          /
          sum(rate(batch_job_completed{service="{{service}}"}[{{window}}]))
        error_budget_burn:
          fast: 6h
          slow: 48h

      duration_p95:
        target: 90.0
        threshold_minutes: 60
        sli_query: |
          histogram_quantile(0.95,
            sum(rate(batch_job_duration_seconds_bucket{service="{{service}}"}[{{window}}])) by (le)
          ) < (60 * 60)

    tier-3:
      success_rate:
        target: 95.0
        sli_query: |
          sum(rate(batch_job_completed{service="{{service}}",status="success"}[{{window}}]))
          /
          sum(rate(batch_job_completed{service="{{service}}"}[{{window}}]))
        error_budget_burn:
          fast: 24h
          slow: 168h  # 1 week

  # GRPC SERVICE TEMPLATES
  grpc-service:
    tier-1:
      availability:
        target: 99.9
        sli_query: |
          sum(rate(grpc_server_handled_total{service="{{service}}",grpc_code!="Unknown",grpc_code!="Unavailable"}[{{window}}]))
          /
          sum(rate(grpc_server_handled_total{service="{{service}}"}[{{window}}]))
        error_budget_burn:
          fast: 2h
          slow: 24h

      latency_p99:
        target: 99.0
        threshold_ms: 100  # gRPC typically faster than HTTP
        sli_query: |
          histogram_quantile(0.99,
            sum(rate(grpc_server_handling_seconds_bucket{service="{{service}}"}[{{window}}])) by (le)
          ) < 0.1

  # DATA PIPELINE TEMPLATES
  data-pipeline:
    tier-1:
      freshness:
        target: 99.9  # Data updated within SLA
        threshold_minutes: 15
        sli_query: |
          (time() - pipeline_last_successful_run_timestamp{service="{{service}}"}) < (15 * 60)

      completeness:
        target: 99.9  # % of expected records processed
        sli_query: |
          sum(rate(pipeline_records_processed{service="{{service}}"}[{{window}}]))
          /
          sum(rate(pipeline_records_expected{service="{{service}}"}[{{window}}]))

      accuracy:
        target: 99.99  # % of records without errors
        sli_query: |
          sum(rate(pipeline_records_valid{service="{{service}}"}[{{window}}]))
          /
          sum(rate(pipeline_records_processed{service="{{service}}"}[{{window}}]))

error_budget_policies:
  tier-1:
    page: "0.1%"  # Page if burning 0.1% of monthly budget in 1h
    warn: "1%"    # Warn if burning 1% of monthly budget in 6h
  tier-2:
    page: "0.5%"
    warn: "2%"
  tier-3:
    page: "2%"
    warn: "5%"

alerting_windows:
  # Multi-window, multi-burn-rate alerts (Google SRE best practice)
  fast_burn:
    lookback: 1h
    errors: 14.4  # 2% error budget burn rate
  slow_burn:
    lookback: 6h
    errors: 6     # 1% error budget burn rate
